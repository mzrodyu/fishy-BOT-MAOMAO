<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>æ¸¸æˆç®¡ç† - å°é±¼å¨˜åå°</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #1a1a2e;
        color: #eee;
        min-height: 100vh;
      }
      .container {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: 200px;
        background: #16213e;
        padding: 20px 0;
      }
      .sidebar h2 {
        color: #fff;
        padding: 0 20px 20px;
        border-bottom: 1px solid #1a1a2e;
      }
      .sidebar a {
        display: block;
        padding: 12px 20px;
        color: #aaa;
        text-decoration: none;
      }
      .sidebar a:hover,
      .sidebar a.active {
        background: #1a1a2e;
        color: #4fc3f7;
      }
      .main {
        flex: 1;
        padding: 30px;
      }
      .main h1 {
        margin-bottom: 20px;
        color: #4fc3f7;
      }
      .card {
        background: #16213e;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .card h3 {
        margin-bottom: 15px;
        color: #4fc3f7;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #aaa;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #333;
        border-radius: 5px;
        background: #1a1a2e;
        color: #fff;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-primary {
        background: #4fc3f7;
        color: #000;
      }
      .btn-danger {
        background: #f44336;
        color: #fff;
      }
      .btn-success {
        background: #4caf50;
        color: #fff;
      }
      .btn:hover {
        opacity: 0.8;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #333;
      }
      th {
        color: #4fc3f7;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: #16213e;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
      }
      .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #4fc3f7;
      }
      .stat-card .label {
        color: #aaa;
        margin-top: 5px;
      }
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 20px;
        background: #16213e;
        border: none;
        color: #aaa;
        cursor: pointer;
        border-radius: 5px;
      }
      .tab.active {
        background: #4fc3f7;
        color: #000;
      }
      .hidden {
        display: none;
      }
      .inline-form {
        display: flex;
        gap: 10px;
        align-items: end;
      }
      .inline-form .form-group {
        margin-bottom: 0;
      }
      .bot-selector {
        margin-bottom: 20px;
      }
      .bot-selector select {
        padding: 10px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <h2>ğŸ± å°é±¼å¨˜</h2>
        <a href="/admin/bots">ğŸ¤– BOTç®¡ç†</a>
        <a href="/admin/settings">âš™ï¸ è®¾ç½®</a>
        <a href="/admin/knowledge">ğŸ“š çŸ¥è¯†åº“</a>
        <a href="/admin/game" class="active">ğŸ® æ¸¸æˆç®¡ç†</a>
        <a href="/admin/stats">ğŸ“Š ç»Ÿè®¡</a>
      </div>
      <div class="main">
        <h1>
          ğŸ® æ¸¸æˆç®¡ç†
          <button
            class="btn btn-primary"
            onclick="migrateData()"
            style="margin-left: 20px; font-size: 14px"
          >
            ğŸ“¦ ä»æœ¬åœ°è¿ç§»æ•°æ®
          </button>
        </h1>

        <div class="bot-selector">
          <label>é€‰æ‹©BOTï¼š</label>
          <select id="botSelect" onchange="loadData()">
            {% for bot in bots %}
            <option value="{{ bot.id }}">{{ bot.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="tabs">
          <button class="tab active" onclick="showTab('users')">
            ğŸ‘¥ ç”¨æˆ·ç®¡ç†
          </button>
          <button class="tab" onclick="showTab('shop')">ğŸª å•†åº—ç®¡ç†</button>
          <button class="tab" onclick="showTab('leaderboard')">
            ğŸ† æ’è¡Œæ¦œ
          </button>
        </div>

        <!-- ç”¨æˆ·ç®¡ç† -->
        <div id="tab-users">
          <div class="card">
            <h3>ğŸ’° å‘æ”¾/æ‰£é™¤åŸºç±³å¸</h3>
            <div class="inline-form">
              <div class="form-group">
                <label>ç”¨æˆ·ID</label>
                <input type="text" id="userId" placeholder="Discordç”¨æˆ·ID" />
              </div>
              <div class="form-group">
                <label>æ•°é‡</label>
                <input type="number" id="coinAmount" value="100" />
              </div>
              <div class="form-group">
                <label>è¯´æ˜</label>
                <input type="text" id="coinDesc" placeholder="ç®¡ç†å‘˜æ“ä½œ" />
              </div>
              <button class="btn btn-success" onclick="addCoins()">å‘æ”¾</button>
              <button class="btn btn-danger" onclick="deductCoins()">
                æ‰£é™¤
              </button>
            </div>
          </div>

          <div class="card">
            <h3>ğŸ” æŸ¥è¯¢ç”¨æˆ·</h3>
            <div class="inline-form">
              <div class="form-group">
                <label>ç”¨æˆ·ID</label>
                <input
                  type="text"
                  id="queryUserId"
                  placeholder="Discordç”¨æˆ·ID"
                />
              </div>
              <button class="btn btn-primary" onclick="queryUser()">
                æŸ¥è¯¢
              </button>
            </div>
            <div id="userInfo" style="margin-top: 15px"></div>
          </div>
        </div>

        <!-- å•†åº—ç®¡ç† -->
        <div id="tab-shop" class="hidden">
          <div class="card">
            <h3>â• æ·»åŠ å•†å“</h3>
            <div class="inline-form">
              <div class="form-group">
                <label>å•†å“ID</label>
                <input type="text" id="itemId" placeholder="gift_xxx" />
              </div>
              <div class="form-group">
                <label>åç§°</label>
                <input type="text" id="itemName" placeholder="ğŸ ç¤¼ç‰©åç§°" />
              </div>
              <div class="form-group">
                <label>ä»·æ ¼</label>
                <input type="number" id="itemPrice" value="100" />
              </div>
              <div class="form-group">
                <label>å¥½æ„Ÿåº¦</label>
                <input type="number" id="itemFavor" value="10" />
              </div>
              <button class="btn btn-primary" onclick="addItem()">æ·»åŠ </button>
            </div>
            <div class="form-group" style="margin-top: 10px">
              <label>æè¿°</label>
              <input type="text" id="itemDesc" placeholder="å•†å“æè¿°" />
            </div>
          </div>

          <div class="card">
            <h3>ğŸª å•†å“åˆ—è¡¨</h3>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>åç§°</th>
                  <th>æè¿°</th>
                  <th>ä»·æ ¼</th>
                  <th>æ•ˆæœ</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="shopItems"></tbody>
            </table>
          </div>
        </div>

        <!-- æ’è¡Œæ¦œ -->
        <div id="tab-leaderboard" class="hidden">
          <div class="stats">
            <div class="stat-card">
              <div class="value" id="totalUsers">0</div>
              <div class="label">æ€»ç”¨æˆ·æ•°</div>
            </div>
            <div class="stat-card">
              <div class="value" id="totalCoins">0</div>
              <div class="label">æµé€šåŸºç±³å¸</div>
            </div>
          </div>

          <div class="card">
            <h3>ğŸ’° åŸºç±³å¸æ’è¡Œ</h3>
            <table>
              <thead>
                <tr>
                  <th>æ’å</th>
                  <th>ç”¨æˆ·ID</th>
                  <th>åŸºç±³å¸</th>
                </tr>
              </thead>
              <tbody id="coinsLeaderboard"></tbody>
            </table>
          </div>

          <div class="card">
            <h3>â¤ï¸ å¥½æ„Ÿåº¦æ’è¡Œ</h3>
            <table>
              <thead>
                <tr>
                  <th>æ’å</th>
                  <th>ç”¨æˆ·ID</th>
                  <th>ç­‰çº§</th>
                  <th>ç»éªŒ</th>
                </tr>
              </thead>
              <tbody id="affectionLeaderboard"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentBot = "default";

      function showTab(tab) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll('[id^="tab-"]')
          .forEach((t) => t.classList.add("hidden"));
        event.target.classList.add("active");
        document.getElementById("tab-" + tab).classList.remove("hidden");

        if (tab === "leaderboard") loadLeaderboard();
        if (tab === "shop") loadShop();
      }

      function loadData() {
        currentBot = document.getElementById("botSelect").value;
        loadShop();
        loadLeaderboard();
      }

      async function addCoins() {
        const userId = document.getElementById("userId").value;
        const amount = parseInt(document.getElementById("coinAmount").value);
        const desc = document.getElementById("coinDesc").value || "ç®¡ç†å‘˜å‘æ”¾";

        if (!userId) return alert("è¯·è¾“å…¥ç”¨æˆ·ID");

        const resp = await fetch(
          `/api/game/currency/${currentBot}/${userId}/add?amount=${amount}&description=${encodeURIComponent(
            desc
          )}`,
          { method: "POST" }
        );
        const data = await resp.json();

        if (data.success) {
          alert(`æˆåŠŸï¼æ–°ä½™é¢: ${data.coins} åŸºç±³å¸`);
        } else {
          alert("å¤±è´¥: " + data.error);
        }
      }

      async function deductCoins() {
        const userId = document.getElementById("userId").value;
        const amount = parseInt(document.getElementById("coinAmount").value);
        const desc = document.getElementById("coinDesc").value || "ç®¡ç†å‘˜æ‰£é™¤";

        if (!userId) return alert("è¯·è¾“å…¥ç”¨æˆ·ID");

        const resp = await fetch(
          `/api/game/currency/${currentBot}/${userId}/deduct?amount=${amount}&description=${encodeURIComponent(
            desc
          )}`,
          { method: "POST" }
        );
        const data = await resp.json();

        if (data.success) {
          alert(`æˆåŠŸï¼æ–°ä½™é¢: ${data.coins} åŸºç±³å¸`);
        } else {
          alert("å¤±è´¥: " + data.error);
        }
      }

      async function queryUser() {
        const userId = document.getElementById("queryUserId").value;
        if (!userId) return alert("è¯·è¾“å…¥ç”¨æˆ·ID");

        const [currResp, affResp] = await Promise.all([
          fetch(`/api/game/currency/${currentBot}/${userId}`),
          fetch(`/api/game/affection/${currentBot}/${userId}`),
        ]);

        const currency = await currResp.json();
        const affection = await affResp.json();

        document.getElementById("userInfo").innerHTML = `
                <table>
                    <tr><td>ğŸ’° åŸºç±³å¸</td><td>${currency.coins}</td></tr>
                    <tr><td>ğŸ“… ä¸Šæ¬¡ç­¾åˆ°</td><td>${
                      currency.last_daily || "ä»æœª"
                    }</td></tr>
                    <tr><td>â¤ï¸ å¥½æ„Ÿç­‰çº§</td><td>Lv.${affection.level}</td></tr>
                    <tr><td>âœ¨ å½“å‰ç»éªŒ</td><td>${affection.exp}/100</td></tr>
                    <tr><td>ğŸ æ€»é€ç¤¼æ•°</td><td>${
                      affection.total_gifts
                    }</td></tr>
                </table>
            `;
      }

      async function loadShop() {
        const resp = await fetch(`/api/game/shop/${currentBot}`);
        const data = await resp.json();

        const tbody = document.getElementById("shopItems");
        tbody.innerHTML = data.items
          .map(
            (item) => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.description}</td>
                    <td>${item.price}</td>
                    <td>å¥½æ„Ÿ+${item.effect.favor || 0}</td>
                    <td><button class="btn btn-danger" onclick="deleteItem('${
                      item.id
                    }')">åˆ é™¤</button></td>
                </tr>
            `
          )
          .join("");
      }

      async function addItem() {
        const id = document.getElementById("itemId").value;
        const name = document.getElementById("itemName").value;
        const price = document.getElementById("itemPrice").value;
        const favor = document.getElementById("itemFavor").value;
        const desc = document.getElementById("itemDesc").value;

        if (!id || !name) return alert("è¯·å¡«å†™å•†å“IDå’Œåç§°");

        const resp = await fetch(`/api/game/shop/${currentBot}/add`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id,
            name,
            description: desc,
            price: parseInt(price),
            effect: { favor: parseInt(favor) },
          }),
        });

        if (resp.ok) {
          alert("æ·»åŠ æˆåŠŸ");
          loadShop();
        }
      }

      async function deleteItem(itemId) {
        if (!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªå•†å“ï¼Ÿ")) return;
        await fetch(`/api/game/shop/${currentBot}/${itemId}`, {
          method: "DELETE",
        });
        loadShop();
      }

      async function loadLeaderboard() {
        const [coinsResp, affResp] = await Promise.all([
          fetch(`/api/game/leaderboard/${currentBot}?type=coins&limit=10`),
          fetch(`/api/game/leaderboard/${currentBot}?type=affection&limit=10`),
        ]);

        const coinsData = await coinsResp.json();
        const affData = await affResp.json();

        document.getElementById("coinsLeaderboard").innerHTML =
          coinsData.leaderboard
            .map(
              (u, i) => `
                <tr><td>#${i + 1}</td><td>${u.user_id}</td><td>${
                u.coins
              }</td></tr>
            `
            )
            .join("") || '<tr><td colspan="3">æš‚æ— æ•°æ®</td></tr>';

        document.getElementById("affectionLeaderboard").innerHTML =
          affData.leaderboard
            .map(
              (u, i) => `
                <tr><td>#${i + 1}</td><td>${u.user_id}</td><td>Lv.${
                u.level
              }</td><td>${u.exp}/100</td></tr>
            `
            )
            .join("") || '<tr><td colspan="4">æš‚æ— æ•°æ®</td></tr>';

        // ç»Ÿè®¡
        document.getElementById("totalUsers").textContent =
          coinsData.leaderboard.length;
        document.getElementById("totalCoins").textContent =
          coinsData.leaderboard.reduce((sum, u) => sum + u.coins, 0);
      }

      async function migrateData() {
        if (!confirm("ç¡®å®šä»å°é±¼å¨˜æœ¬åœ° bot_data.json è¿ç§»æ•°æ®åˆ°åç«¯æ•°æ®åº“ï¼Ÿ"))
          return;

        const resp = await fetch("/api/game/migrate", { method: "POST" });
        const data = await resp.json();

        if (data.success) {
          alert(data.message);
          // åˆ‡æ¢åˆ°å°é±¼å¨˜å¹¶åˆ·æ–°æ•°æ®
          document.getElementById("botSelect").value = "maodie";
          loadData();
        } else {
          alert("è¿ç§»å¤±è´¥: " + data.error);
        }
      }

      // åˆå§‹åŒ–
      loadData();
    </script>
  </body>
</html>
